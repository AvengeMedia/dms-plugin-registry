name: Theme Preview

on:
  pull_request_target:
    branches: [master]
    paths:
      - 'themes/**'

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr

      - name: Install dependencies
        run: sudo apt-get install -y librsvg2-bin

      - name: Find changed themes and generate previews
        id: preview
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd pr

          git fetch origin ${{ github.event.pull_request.base.sha }} --depth=1

          changed_themes=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} -- themes/ | \
            grep -oP '^themes/[^/]+' | sort -u || true)

          if [ -z "$changed_themes" ]; then
            echo "No theme changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          python3 .github/generate_theme_previews.py

          echo "## Theme Preview" > ../comment.md
          echo "" >> ../comment.md

          for theme_path in $changed_themes; do
            theme_dir="$theme_path"
            if [ ! -f "${theme_dir}/theme.json" ]; then
              continue
            fi

            if [ ! -d "../base/${theme_dir}" ]; then
              badge="(new)"
            else
              badge="(updated)"
            fi

            name=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['name'])")
            author=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['author'])")
            desc=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['description'])")
            theme_slug=$(basename "$theme_dir")

            echo "### ${name} ${badge}" >> ../comment.md
            echo "" >> ../comment.md
            echo "> ${desc}" >> ../comment.md
            echo "" >> ../comment.md
            echo "**Author:** ${author}" >> ../comment.md
            echo "" >> ../comment.md

            if [ -f "${theme_dir}/preview.svg" ]; then
              rsvg-convert "${theme_dir}/preview.svg" -o "/tmp/${theme_slug}.png"

              # Upload image to GitHub using their upload API
              response=$(curl -s -X POST \
                -H "Authorization: token $GH_TOKEN" \
                -H "Content-Type: image/png" \
                -H "Accept: application/json" \
                --data-binary "@/tmp/${theme_slug}.png" \
                "https://uploads.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/assets?name=${theme_slug}.png")

              img_url=$(echo "$response" | python3 -c "import sys,json; print(json.load(sys.stdin).get('href',''))" 2>/dev/null || true)

              if [ -n "$img_url" ]; then
                echo "![${name}](${img_url})" >> ../comment.md
              else
                echo "_Preview generation failed_" >> ../comment.md
              fi
              echo "" >> ../comment.md
            fi

            echo "---" >> ../comment.md
            echo "" >> ../comment.md
          done

      - name: Post preview comment
        if: steps.preview.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
