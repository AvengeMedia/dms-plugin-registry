name: Theme Preview

on:
  pull_request_target:
    branches: [master]
    paths:
      - 'themes/**'

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr

      - name: Setup CML
        uses: iterative/setup-cml@v3

      - name: Find changed themes and generate preview comment
        id: preview
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd pr

          # Fetch base ref for comparison
          git fetch origin ${{ github.event.pull_request.base.sha }} --depth=1

          # Get list of theme directories that have changes
          changed_themes=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} -- themes/ | \
            grep -oP '^themes/[^/]+' | sort -u || true)

          if [ -z "$changed_themes" ]; then
            echo "No theme changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Generate previews only for changed themes
          python3 .github/generate_theme_previews.py

          # Build the comment
          echo "## Theme Preview" > ../comment.md
          echo "" >> ../comment.md

          for theme_path in $changed_themes; do
            theme_dir="$theme_path"
            if [ ! -f "${theme_dir}/theme.json" ]; then
              continue
            fi

            # Check if this is a new theme (doesn't exist in base)
            if [ ! -d "../base/${theme_dir}" ]; then
              badge="(new)"
            else
              badge="(updated)"
            fi

            name=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['name'])")
            author=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['author'])")
            desc=$(python3 -c "import json; print(json.load(open('${theme_dir}/theme.json'))['description'])")

            echo "### ${name} ${badge}" >> ../comment.md
            echo "" >> ../comment.md
            echo "> ${desc}" >> ../comment.md
            echo "" >> ../comment.md
            echo "**Author:** ${author}" >> ../comment.md
            echo "" >> ../comment.md

            # Upload SVG and embed as image
            if [ -f "${theme_dir}/preview.svg" ]; then
              img_url=$(cml publish "${theme_dir}/preview.svg")
              echo "![${name} preview](${img_url})" >> ../comment.md
              echo "" >> ../comment.md
            fi

            echo "---" >> ../comment.md
            echo "" >> ../comment.md
          done

      - name: Post preview comment
        if: steps.preview.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
